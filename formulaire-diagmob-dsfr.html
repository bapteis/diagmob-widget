<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diag Mob - Diagnostic MobilitÃ©</title>
  
  <!-- DSFR CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
  <link rel="stylesheet" href="https://unpkg.com/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">
  
  <!-- Grist API -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    
    .container-formulaire {
      max-width: 700px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    
    /* Force disposition verticale pour tous les groupes */
    .fr-fieldset__content {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    /* Supprimer la disposition en grille par dÃ©faut */
    .fr-fieldset--inline .fr-fieldset__content {
      display: flex;
      flex-direction: column;
    }
    
    /* Chaque groupe d'input sur toute la largeur */
    .fr-input-group,
    .fr-select-group,
    .fr-checkbox-group,
    .fr-radio-group {
      width: 100%;
      max-width: 100%;
    }
    
    /* Suggestions autocomplÃ©tion */
    .autocomplete-wrapper {
      position: relative;
    }
    
    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border-default-grey);
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 0 0 4px 4px;
    }
    
    .suggestions div {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border-default-grey);
    }
    
    .suggestions div:hover {
      background-color: var(--background-alt-blue-france);
    }
    
    /* Message succÃ¨s */
    .success-message {
      display: none;
      background-color: var(--background-contrast-success);
      border-left: 4px solid var(--border-plain-success);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    
    /* Sections espacÃ©es */
    .fr-fieldset {
      margin-bottom: 2rem;
    }
    
    /* LÃ©gende section */
    .fr-fieldset__legend h2 {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>

  <div class="container-formulaire">
    
    <!-- En-tÃªte -->
    <div class="fr-mb-4w">
      <h1 class="fr-h3">ğŸ“‹ Diag Mob - Diagnostic MobilitÃ©</h1>
      <p class="fr-text--sm fr-mb-0">
        Vos rÃ©ponses sont confidentielles et traitÃ©es selon le RGPD. 
        Les champs marquÃ©s d'un astÃ©risque (*) sont obligatoires.
      </p>
    </div>

    <!-- Message succÃ¨s -->
    <div class="success-message fr-alert fr-alert--success" id="success-message">
      <p class="fr-alert__title">Merci !</p>
      <p>Votre diagnostic mobilitÃ© a bien Ã©tÃ© enregistrÃ©.</p>
    </div>

    <form id="diagmob-form">
      
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- SECTION 1 : INFORMATIONS PERSONNELLES                   -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <fieldset class="fr-fieldset">
        <legend class="fr-fieldset__legend">
          <h2 class="fr-h5">1. Vos informations</h2>
        </legend>
        
        <div class="fr-fieldset__content">
          
          <!-- RGPD -->
          <div class="fr-form-group">
            <fieldset class="fr-fieldset">
              <legend class="fr-fieldset__legend fr-text--regular">
                J'accepte le traitement de mes donnÃ©es (RGPD) <span class="fr-hint-text">*</span>
              </legend>
              <div class="fr-fieldset__content">
                <div class="fr-radio-group">
                  <input type="radio" id="rgpd-oui" name="rgpd" value="Oui" required>
                  <label class="fr-label" for="rgpd-oui">Oui, j'accepte</label>
                </div>
              </div>
            </fieldset>
          </div>

          <!-- Email -->
          <div class="fr-input-group">
            <label class="fr-label" for="email">
              Adresse mail professionnelle *
              <span class="fr-hint-text">ou personnelle si vous n'en possÃ©dez pas</span>
            </label>
            <input class="fr-input" type="email" id="email" name="email" placeholder="prenom.nom@ministere.gouv.fr" required>
          </div>

          <!-- Service / MinistÃ¨re -->
          <div class="fr-select-group">
            <label class="fr-label" for="service">
              Service / MinistÃ¨re de rattachement *
            </label>
            <select class="fr-select" id="service" name="service" required>
              <option value="">-- SÃ©lectionnez votre service --</option>
              <!-- Options chargÃ©es dynamiquement depuis Grist -->
            </select>
          </div>

        </div>
      </fieldset>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- SECTION 2 : VOS TRAJETS                                 -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <fieldset class="fr-fieldset">
        <legend class="fr-fieldset__legend">
          <h2 class="fr-h5">2. Vos trajets</h2>
        </legend>
        
        <div class="fr-fieldset__content">
          
          <!-- Adresse domicile -->
          <div class="fr-input-group">
            <label class="fr-label" for="adresse-domicile">
              Adresse de domicile *
            </label>
            <div class="autocomplete-wrapper">
              <input class="fr-input" type="text" id="adresse-domicile" name="adresse-domicile" placeholder="Commencez Ã  saisir votre adresse..." required autocomplete="off">
              <div class="suggestions" id="suggestions-domicile"></div>
            </div>
            <input type="hidden" id="gps-dom-lat" name="gps-dom-lat">
            <input type="hidden" id="gps-dom-lon" name="gps-dom-lon">
          </div>

          <!-- Adresse travail -->
          <div class="fr-input-group">
            <label class="fr-label" for="adresse-travail">
              Adresse de travail *
            </label>
            <div class="autocomplete-wrapper">
              <input class="fr-input" type="text" id="adresse-travail" name="adresse-travail" placeholder="Commencez Ã  saisir votre adresse..." required autocomplete="off">
              <div class="suggestions" id="suggestions-travail"></div>
            </div>
            <input type="hidden" id="gps-trav-lat" name="gps-trav-lat">
            <input type="hidden" id="gps-trav-lon" name="gps-trav-lon">
          </div>

        </div>
      </fieldset>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- SECTION 3 : HABITUDES DE MOBILITÃ‰                       -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <fieldset class="fr-fieldset">
        <legend class="fr-fieldset__legend">
          <h2 class="fr-h5">3. Habitudes de mobilitÃ©</h2>
        </legend>
        
        <div class="fr-fieldset__content">
          
          <!-- Mode de transport principal -->
          <div class="fr-form-group">
            <fieldset class="fr-fieldset">
              <legend class="fr-fieldset__legend fr-text--regular">
                Mode de transport principal *
              </legend>
              <div class="fr-fieldset__content">
                <div class="fr-radio-group">
                  <input type="radio" id="transport-voiture" name="transport" value="Voiture (sans passagers)" required>
                  <label class="fr-label" for="transport-voiture">ğŸš— Voiture (sans passagers)</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-covoit" name="transport" value="Covoiturage">
                  <label class="fr-label" for="transport-covoit">ğŸš—ğŸ‘¥ Covoiturage</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-tc" name="transport" value="Transports en commun">
                  <label class="fr-label" for="transport-tc">ğŸšŒ Transports en commun</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-velo" name="transport" value="VÃ©lo musculaire">
                  <label class="fr-label" for="transport-velo">ğŸš´ VÃ©lo musculaire</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-vae" name="transport" value="VÃ©lo Ã©lectrique">
                  <label class="fr-label" for="transport-vae">ğŸš´âš¡ VÃ©lo Ã©lectrique</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-marche" name="transport" value="Marche Ã  pied">
                  <label class="fr-label" for="transport-marche">ğŸš¶ Marche Ã  pied</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-inter" name="transport" value="IntermodalitÃ©">
                  <label class="fr-label" for="transport-inter">ğŸš—ğŸšŒ IntermodalitÃ©</label>
                </div>
              </div>
            </fieldset>
          </div>

          <!-- Jours de prÃ©sence -->
          <div class="fr-form-group">
            <fieldset class="fr-fieldset">
              <legend class="fr-fieldset__legend fr-text--regular">
                Jours de prÃ©sence sur site *
              </legend>
              <div class="fr-fieldset__content">
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-lundi" name="jours" value="Lundi">
                  <label class="fr-label" for="jour-lundi">Lundi</label>
                </div>
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-mardi" name="jours" value="Mardi">
                  <label class="fr-label" for="jour-mardi">Mardi</label>
                </div>
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-mercredi" name="jours" value="Mercredi">
                  <label class="fr-label" for="jour-mercredi">Mercredi</label>
                </div>
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-jeudi" name="jours" value="Jeudi">
                  <label class="fr-label" for="jour-jeudi">Jeudi</label>
                </div>
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-vendredi" name="jours" value="Vendredi">
                  <label class="fr-label" for="jour-vendredi">Vendredi</label>
                </div>
              </div>
            </fieldset>
          </div>

          <!-- Heure d'arrivÃ©e -->
          <div class="fr-input-group">
            <label class="fr-label" for="heure-arrivee">
              Heure d'arrivÃ©e habituelle *
            </label>
            <input class="fr-input" type="time" id="heure-arrivee" name="heure-arrivee" required>
          </div>

          <!-- Heure de dÃ©part -->
          <div class="fr-input-group">
            <label class="fr-label" for="heure-depart">
              Heure de dÃ©part habituelle *
            </label>
            <input class="fr-input" type="time" id="heure-depart" name="heure-depart" required>
          </div>

        </div>
      </fieldset>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- SECTION 4 : INFORMATIONS COMPLÃ‰MENTAIRES                -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <fieldset class="fr-fieldset">
        <legend class="fr-fieldset__legend">
          <h2 class="fr-h5">4. Informations complÃ©mentaires</h2>
        </legend>
        
        <div class="fr-fieldset__content">
          
          <!-- Handicap (checkbox boolÃ©enne facultative) -->
          <div class="fr-checkbox-group">
            <input type="checkbox" id="handicap" name="handicap" value="true">
            <label class="fr-label" for="handicap">
              Je suis porteur d'un handicap
              <span class="fr-hint-text">Cette information reste confidentielle et nous permet d'adapter nos propositions de mobilitÃ©</span>
            </label>
          </div>

          <!-- TÃ©lÃ©phone (en bas comme demandÃ©) -->
          <div class="fr-input-group">
            <label class="fr-label" for="telephone">
              NumÃ©ro de tÃ©lÃ©phone
              <span class="fr-hint-text">Si vous Ãªtes volontaire pour nous aider Ã  amÃ©liorer la proposition de mobilitÃ© alternative, indiquez votre numÃ©ro pour qu'on puisse Ã©changer 5 min avec vous</span>
            </label>
            <input class="fr-input" type="tel" id="telephone" name="telephone" placeholder="06 12 34 56 78">
          </div>

        </div>
      </fieldset>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- BOUTON SOUMISSION                                       -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="fr-mt-4w">
        <button type="submit" class="fr-btn" id="btn-submit">
          Envoyer mon diagnostic
        </button>
      </div>

    </form>
  </div>

  <!-- DSFR JS -->
  <script src="https://unpkg.com/@gouvfr/dsfr@1.11.2/dist/dsfr.module.min.js" type="module"></script>
  <script src="https://unpkg.com/@gouvfr/dsfr@1.11.2/dist/dsfr.nomodule.min.js" nomodule></script>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALISATION GRIST
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    grist.ready();
    
    // Charger la liste des services depuis Grist
    async function chargerServices() {
      try {
        const tableData = await grist.docApi.fetchTable('liste_services');
        const select = document.getElementById('service');
        select.innerHTML = '<option value="">-- SÃ©lectionnez votre service --</option>';
        
        // Si la table a une colonne "Service" ou "Libelle"
        const services = tableData.Service || tableData.Libelle || tableData.Nom || [];
        
        services.forEach((service) => {
          if (service) {
            const option = document.createElement('option');
            option.value = service;
            option.textContent = service;
            select.appendChild(option);
          }
        });
      } catch (error) {
        console.log('Mode standalone - Liste services statique');
        // Fallback si pas de Grist : liste statique exemple
        const select = document.getElementById('service');
        select.innerHTML = `
          <option value="">-- SÃ©lectionnez votre service --</option>
          <option value="DGITM">DGITM - Direction GÃ©nÃ©rale des Infrastructures, des Transports et des MobilitÃ©s</option>
          <option value="DREAL">DREAL - Direction RÃ©gionale de l'Environnement, de l'AmÃ©nagement et du Logement</option>
          <option value="DRAAF">DRAAF - Direction RÃ©gionale de l'Alimentation, de l'Agriculture et de la ForÃªt</option>
          <option value="France Travail">France Travail</option>
          <option value="Autre">Autre</option>
        `;
      }
    }
    
    chargerServices();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTOCOMPLÃ‰TION ADRESSES (API BAN)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const gpsData = {
      domicile: { lat: null, lon: null, label: '' },
      travail: { lat: null, lon: null, label: '' }
    };

    function setupAutocomplete(inputId, suggestionsId, type) {
      const input = document.getElementById(inputId);
      const suggestions = document.getElementById(suggestionsId);
      let debounceTimer;

      input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        
        if (query.length < 3) {
          suggestions.style.display = 'none';
          return;
        }

        debounceTimer = setTimeout(async () => {
          try {
            const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
            const data = await response.json();
            
            suggestions.innerHTML = '';
            
            if (data.features && data.features.length > 0) {
              data.features.forEach(feature => {
                const div = document.createElement('div');
                div.textContent = feature.properties.label;
                div.addEventListener('click', () => {
                  input.value = feature.properties.label;
                  gpsData[type].lat = feature.geometry.coordinates[1];
                  gpsData[type].lon = feature.geometry.coordinates[0];
                  gpsData[type].label = feature.properties.label;
                  
                  // Mettre Ã  jour les champs cachÃ©s
                  if (type === 'domicile') {
                    document.getElementById('gps-dom-lat').value = gpsData[type].lat;
                    document.getElementById('gps-dom-lon').value = gpsData[type].lon;
                  } else {
                    document.getElementById('gps-trav-lat').value = gpsData[type].lat;
                    document.getElementById('gps-trav-lon').value = gpsData[type].lon;
                  }
                  
                  suggestions.style.display = 'none';
                });
                suggestions.appendChild(div);
              });
              suggestions.style.display = 'block';
            } else {
              suggestions.style.display = 'none';
            }
          } catch (error) {
            console.error('Erreur API BAN:', error);
          }
        }, 300);
      });

      // Cacher suggestions si clic ailleurs
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
          suggestions.style.display = 'none';
        }
      });
    }

    setupAutocomplete('adresse-domicile', 'suggestions-domicile', 'domicile');
    setupAutocomplete('adresse-travail', 'suggestions-travail', 'travail');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SOUMISSION DU FORMULAIRE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('diagmob-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Validation GPS
      if (!gpsData.domicile.lat || !gpsData.travail.lat) {
        alert('Veuillez sÃ©lectionner une adresse dans la liste de suggestions pour le domicile et le travail.');
        return;
      }

      // RÃ©cupÃ©rer les valeurs
      const email = document.getElementById('email').value;
      const service = document.getElementById('service').value;
      const telephone = document.getElementById('telephone').value || '';
      const handicap = document.getElementById('handicap').checked;
      
      // Jours de prÃ©sence
      const joursChecked = document.querySelectorAll('input[name="jours"]:checked');
      const jours = Array.from(joursChecked).map(cb => cb.value).join(', ');
      
      if (jours.length === 0) {
        alert('Veuillez sÃ©lectionner au moins un jour de prÃ©sence.');
        return;
      }

      const fields = {
        Email_Pro: email,
        Service: service,
        Telephone: telephone,
        Handicap: handicap,
        Adresse_Domicile: gpsData.domicile.label,
        GPS_Dom_Lat: gpsData.domicile.lat,
        GPS_Dom_Lon: gpsData.domicile.lon,
        Adresse_Travail: gpsData.travail.label,
        GPS_Trav_Lat: gpsData.travail.lat,
        GPS_Trav_Lon: gpsData.travail.lon,
        Mode_Transport: document.querySelector('input[name="transport"]:checked').value,
        Jours_Presence: jours,
        Heure_Arrivee: document.getElementById('heure-arrivee').value,
        Heure_Depart: document.getElementById('heure-depart').value
      };
      
      try {
        // DÃ©sactiver le bouton
        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.textContent = 'Envoi en cours...';
        
        // Envoyer Ã  Grist
        await grist.docApi.applyUserActions([
          ['AddRecord', 'DiagmobV2', null, fields]
        ]);
        
        // SuccÃ¨s
        document.getElementById('success-message').style.display = 'block';
        document.getElementById('diagmob-form').reset();
        
        // Scroll vers le haut pour voir le message
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        setTimeout(() => {
          document.getElementById('success-message').style.display = 'none';
          btn.disabled = false;
          btn.textContent = 'Envoyer mon diagnostic';
        }, 5000);
        
      } catch (error) {
        console.error('Erreur soumission:', error);
        alert('Erreur lors de l\'envoi. Veuillez rÃ©essayer.');
        
        const btn = document.getElementById('btn-submit');
        btn.disabled = false;
        btn.textContent = 'Envoyer mon diagnostic';
      }
    });
  </script>

</body>
</html>
