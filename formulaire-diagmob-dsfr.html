<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diag Mob - Diagnostic Mobilit√©</title>
  
  <!-- DSFR CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
  <link rel="stylesheet" href="https://unpkg.com/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">
  
  <!-- Grist API -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <!-- Polyline encoder (pour compacter les trajets GeoJSON) -->
  <script src="https://unpkg.com/@mapbox/polyline@1.1.1/src/polyline.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    
    .container-formulaire {
      max-width: 700px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    
    /* Force disposition verticale pour tous les groupes */
    .fr-fieldset__content {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    /* Chaque groupe d'input sur toute la largeur */
    .fr-input-group,
    .fr-select-group,
    .fr-checkbox-group,
    .fr-radio-group {
      width: 100%;
      max-width: 100%;
    }
    
    /* Fix checkbox Lundi - forcer carr√© parfait */
    .fr-checkbox-group input[type="checkbox"] {
      width: 1.5rem !important;
      height: 1.5rem !important;
      min-width: 1.5rem !important;
      min-height: 1.5rem !important;
    }
    
    /* Suggestions autocompl√©tion */
    .autocomplete-wrapper {
      position: relative;
    }
    
    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border-default-grey);
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 0 0 4px 4px;
    }
    
    .suggestions div {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border-default-grey);
    }
    
    .suggestions div:hover {
      background-color: var(--background-alt-blue-france);
    }
    
    /* Message succ√®s */
    .success-message {
      display: none;
      background-color: var(--background-contrast-success);
      border-left: 4px solid var(--border-plain-success);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    
    /* Sections espac√©es */
    .fr-fieldset {
      margin-bottom: 2rem;
    }
    
    /* Questions conditionnelles */
    .question-conditionnelle {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background-color: var(--background-alt-blue-france);
      border-radius: 4px;
      border-left: 3px solid var(--border-action-high-blue-france);
    }
    
    .question-conditionnelle.visible {
      display: block;
    }
    
    /* Texte intro */
    .intro-text {
      background-color: var(--background-alt-blue-france);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }
    
    .intro-text ul {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }
    
    .intro-text li {
      margin-bottom: 0.5rem;
    }
    
    /* Select avec plus d'options visibles */
    .fr-select {
      max-height: none;
    }
  </style>
</head>
<body>

  <div class="container-formulaire">
    
    <!-- En-t√™te -->
    <div class="fr-mb-2w">
      <h1 class="fr-h3">üìã Diag Mob - Diagnostic Mobilit√©</h1>
      <p class="fr-text--sm fr-mb-0">
        Les champs marqu√©s d'un ast√©risque (*) sont obligatoires.
      </p>
    </div>

    <!-- Texte introductif -->
    <div class="intro-text">
      <p><strong>Bonjour,</strong></p>
      <p>Et si vos trajets domicile-travail devenaient plus √©conomiques, conviviaux et √©cologiques ?</p>
      <p>Nous lan√ßons un service num√©rique sur le potentiel de mobilit√© alternatives entre agents publics, port√©e par le minist√®re des Transports et la Fabrique Num√©rique.</p>
      <p>üëâ <strong>Exemple concret :</strong> un agent qui habite √† 30 km de son lieu de travail et covoiture en alternance avec un coll√®gue √©conomise pr√®s de <strong>2 000 ‚Ç¨ par an</strong>.</p>
      <p>En r√©pondant √† ce questionnaire, vous pourrez :</p>
      <ul>
        <li>R√©duire vos frais de d√©placement,</li>
        <li>√ätre mis en relation avec des coll√®gues proches de chez vous pour exp√©rimenter le covoiturage ou le v√©lotaf,</li>
        <li>B√©n√©ficier du Forfait Mobilit√©s Durables (100 √† 300 ‚Ç¨ par an),</li>
        <li>Contribuer √† la transition √©cologique.</li>
      </ul>
    </div>

    <!-- Message succ√®s -->
    <div class="success-message fr-alert fr-alert--success" id="success-message">
      <p class="fr-alert__title">Merci !</p>
      <p>Votre diagnostic mobilit√© a bien √©t√© enregistr√©.</p>
    </div>

    <form id="diagmob-form">
      
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- SECTION 1 : INFORMATIONS PERSONNELLES                   -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <fieldset class="fr-fieldset">
        <legend class="fr-fieldset__legend">
          <h2 class="fr-h5">1. Vos informations</h2>
        </legend>
        
        <div class="fr-fieldset__content">
          
          <!-- RGPD avec texte complet -->
          <div class="fr-checkbox-group">
            <input type="checkbox" id="rgpd" name="rgpd" value="Oui" required>
            <label class="fr-label" for="rgpd">
              J'accepte le traitement de mes donn√©es (RGPD) *
              <span class="fr-hint-text">J'accepte que mes donn√©es personnelles (ville de domicile, adresse de travail et adresse e-mail) soient utilis√©es uniquement dans le cadre de cette d√©marche de cartographie des trajets et de changement d'habitude de mobilit√©s par l'√©quipe Diag'Mob et les r√©f√©rents mobilit√©s de mon service, pendant une dur√©e maximale de 12 mois, conform√©ment aux informations fournies sur notre page RGPD.</span>
            </label>
          </div>

          <!-- Email -->
          <div class="fr-input-group">
            <label class="fr-label" for="email">
              Adresse mail professionnelle *
              <span class="fr-hint-text">ou personnelle si vous n'en poss√©dez pas</span>
            </label>
            <input class="fr-input" type="email" id="email" name="email" placeholder="prenom.nom@ministere.gouv.fr" required>
          </div>

          <!-- Service / Minist√®re -->
          <div class="fr-select-group">
            <label class="fr-label" for="service">
              Service / Minist√®re de rattachement *
            </label>
            <select class="fr-select" id="service" name="service" required>
              <option value="">‚Äî S√©lectionnez votre service ‚Äî</option>
              <option value="Services du Premier ministre">Services du Premier ministre</option>
              <option value="Minist√®re de l'Int√©rieur et des Outre-mer">Minist√®re de l'Int√©rieur et des Outre-mer</option>
              <option value="Minist√®re de la Justice">Minist√®re de la Justice</option>
              <option value="Minist√®re des Arm√©es">Minist√®re des Arm√©es</option>
              <option value="Minist√®re de l'√âconomie et des Finances">Minist√®re de l'√âconomie et des Finances</option>
              <option value="Minist√®re de l'√âducation nationale et de la Jeunesse">Minist√®re de l'√âducation nationale et de la Jeunesse</option>
              <option value="Minist√®re de l'Enseignement sup√©rieur et de la Recherche">Minist√®re de l'Enseignement sup√©rieur et de la Recherche</option>
              <option value="Minist√®re de l'Agriculture et de la Souverainet√© alimentaire">Minist√®re de l'Agriculture et de la Souverainet√© alimentaire</option>
              <option value="Minist√®re de la Transition √©cologique">Minist√®re de la Transition √©cologique</option>
              <option value="Minist√®re de la Sant√© et des Solidarit√©s">Minist√®re de la Sant√© et des Solidarit√©s</option>
              <option value="Minist√®re de la Culture">Minist√®re de la Culture</option>
              <option value="Minist√®re du Travail et des Solidarit√©s">Minist√®re du Travail et des Solidarit√©s</option>
              <option value="Direction r√©gionale de l'√©conomie, de l'emploi, du travail et des solidarit√©s">Direction r√©gionale de l'√©conomie, de l'emploi, du travail et des solidarit√©s</option>
              <option value="Direction r√©gionale de l'environnement, de l'am√©nagement et du logement">Direction r√©gionale de l'environnement, de l'am√©nagement et du logement</option>
              <option value="Direction r√©gionale de l'alimentation, de l'agriculture et de la for√™t">Direction r√©gionale de l'alimentation, de l'agriculture et de la for√™t</option>
              <option value="Direction r√©gionale des affaires culturelles">Direction r√©gionale des affaires culturelles</option>
              <option value="Rectorat d'acad√©mie">Rectorat d'acad√©mie</option>
              <option value="Agence r√©gionale de sant√©">Agence r√©gionale de sant√©</option>
              <option value="Direction d√©partementale des territoires">Direction d√©partementale des territoires</option>
              <option value="Direction d√©partementale des territoires et de la mer">Direction d√©partementale des territoires et de la mer</option>
              <option value="Direction d√©partementale de l'emploi, du travail et des solidarit√©s">Direction d√©partementale de l'emploi, du travail et des solidarit√©s</option>
              <option value="Direction d√©partementale de la protection des populations">Direction d√©partementale de la protection des populations</option>
              <option value="Direction d√©partementale de l'emploi, du travail, des solidarit√©s et de la protection des populations">Direction d√©partementale de l'emploi, du travail, des solidarit√©s et de la protection des populations</option>
              <option value="Direction des services d√©partementaux de l'√©ducation nationale">Direction des services d√©partementaux de l'√©ducation nationale</option>
              <option value="Direction d√©partementale des finances publiques">Direction d√©partementale des finances publiques</option>
              <option value="Pr√©fecture de d√©partement">Pr√©fecture de d√©partement</option>
              <option value="Sous-pr√©fecture">Sous-pr√©fecture</option>
              <option value="France Travail">France Travail</option>
              <option value="Caisse d'Allocations Familiales">Caisse d'Allocations Familiales</option>
              <option value="Caisse Primaire d'Assurance Maladie">Caisse Primaire d'Assurance Maladie</option>
              <option value="Agence de l'environnement et de la ma√Ætrise de l'√©nergie">Agence de l'environnement et de la ma√Ætrise de l'√©nergie</option>
              <option value="Centre national de la recherche scientifique">Centre national de la recherche scientifique</option>
              <option value="Autre service">Autre service</option>
            </select>
          </div>

        </div>
      </fieldset>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- SECTION 2 : VOS TRAJETS                                 -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <fieldset class="fr-fieldset">
        <legend class="fr-fieldset__legend">
          <h2 class="fr-h5">2. Vos trajets</h2>
        </legend>
        
        <div class="fr-fieldset__content">
          
          <!-- Adresse domicile -->
          <div class="fr-input-group">
            <label class="fr-label" for="adresse-domicile">
              Adresse de domicile *
            </label>
            <div class="autocomplete-wrapper">
              <input class="fr-input" type="text" id="adresse-domicile" name="adresse-domicile" placeholder="Commencez √† saisir votre adresse..." required autocomplete="off">
              <div class="suggestions" id="suggestions-domicile"></div>
            </div>
            <input type="hidden" id="gps-dom-lat" name="gps-dom-lat">
            <input type="hidden" id="gps-dom-lon" name="gps-dom-lon">
          </div>

          <!-- Adresse travail -->
          <div class="fr-input-group">
            <label class="fr-label" for="adresse-travail">
              Adresse de travail *
            </label>
            <div class="autocomplete-wrapper">
              <input class="fr-input" type="text" id="adresse-travail" name="adresse-travail" placeholder="Commencez √† saisir votre adresse..." required autocomplete="off">
              <div class="suggestions" id="suggestions-travail"></div>
            </div>
            <input type="hidden" id="gps-trav-lat" name="gps-trav-lat">
            <input type="hidden" id="gps-trav-lon" name="gps-trav-lon">
          </div>

        </div>
      </fieldset>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- SECTION 3 : HABITUDES DE MOBILIT√â                       -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <fieldset class="fr-fieldset">
        <legend class="fr-fieldset__legend">
          <h2 class="fr-h5">3. Habitudes de mobilit√©</h2>
        </legend>
        
        <div class="fr-fieldset__content">
          
          <!-- Mode de transport principal -->
          <div class="fr-form-group">
            <fieldset class="fr-fieldset">
              <legend class="fr-fieldset__legend fr-text--regular">
                Mode de transport principal *
              </legend>
              <div class="fr-fieldset__content">
                <div class="fr-radio-group">
                  <input type="radio" id="transport-voiture" name="transport" value="Voiture (sans passagers)" required>
                  <label class="fr-label" for="transport-voiture">üöó Voiture (sans passagers)</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-covoit" name="transport" value="Covoiturage">
                  <label class="fr-label" for="transport-covoit">üöóüë• Covoiturage</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-tc" name="transport" value="Transports en commun">
                  <label class="fr-label" for="transport-tc">üöå Transports en commun</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-velo" name="transport" value="V√©lo musculaire">
                  <label class="fr-label" for="transport-velo">üö¥ V√©lo musculaire</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-vae" name="transport" value="V√©lo √©lectrique">
                  <label class="fr-label" for="transport-vae">üö¥‚ö° V√©lo √©lectrique</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-marche" name="transport" value="Marche √† pied">
                  <label class="fr-label" for="transport-marche">üö∂ Marche √† pied</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-inter" name="transport" value="Intermodalit√©">
                  <label class="fr-label" for="transport-inter">üöóüöå Intermodalit√©</label>
                </div>
              </div>
            </fieldset>
            
            <!-- Question conditionnelle : Difficult√© parking (si voiture) -->
            <div class="question-conditionnelle" id="question-parking">
              <div class="fr-checkbox-group">
                <input type="checkbox" id="difficulte-parking" name="difficulte-parking" value="true">
                <label class="fr-label" for="difficulte-parking">
                  J'ai des difficult√©s √† me garer sur mon lieu de travail
                </label>
              </div>
            </div>
            
            <!-- Question conditionnelle : Mentor v√©lo (si v√©lo) -->
            <div class="question-conditionnelle" id="question-mentor-velo">
              <div class="fr-checkbox-group">
                <input type="checkbox" id="mentor-velo" name="mentor-velo" value="true">
                <label class="fr-label" for="mentor-velo">
                  Je suis pr√™t(e) √† √™tre mentor v√©lo pour accompagner un coll√®gue dans ses premiers trajets
                  <span class="fr-hint-text">Vous pourrez √™tre mis en relation avec des coll√®gues souhaitant d√©buter le v√©lotaf</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Nombre de jours pr√©sent sur site par semaine -->
          <div class="fr-select-group">
            <label class="fr-label" for="nb-jours-semaine">
              Nombre de jours pr√©sent sur site par semaine *
            </label>
            <select class="fr-select" id="nb-jours-semaine" name="nb-jours-semaine" required>
              <option value="">-- S√©lectionnez --</option>
              <option value="1">1 jour</option>
              <option value="2">2 jours</option>
              <option value="3">3 jours</option>
              <option value="4">4 jours</option>
              <option value="5">5 jours</option>
            </select>
          </div>

          <!-- Jours de pr√©sence -->
          <div class="fr-form-group">
            <fieldset class="fr-fieldset">
              <legend class="fr-fieldset__legend fr-text--regular">
                Jours de pr√©sence sur site *
              </legend>
              <div class="fr-fieldset__content">
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-lundi" name="jours" value="Lundi">
                  <label class="fr-label" for="jour-lundi">Lundi</label>
                </div>
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-mardi" name="jours" value="Mardi">
                  <label class="fr-label" for="jour-mardi">Mardi</label>
                </div>
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-mercredi" name="jours" value="Mercredi">
                  <label class="fr-label" for="jour-mercredi">Mercredi</label>
                </div>
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-jeudi" name="jours" value="Jeudi">
                  <label class="fr-label" for="jour-jeudi">Jeudi</label>
                </div>
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-vendredi" name="jours" value="Vendredi">
                  <label class="fr-label" for="jour-vendredi">Vendredi</label>
                </div>
              </div>
            </fieldset>
          </div>

          <!-- Heure d'arriv√©e -->
          <div class="fr-input-group">
            <label class="fr-label" for="heure-arrivee">
              Heure d'arriv√©e habituelle *
            </label>
            <input class="fr-input" type="time" id="heure-arrivee" name="heure-arrivee" required>
          </div>

          <!-- Heure de d√©part -->
          <div class="fr-input-group">
            <label class="fr-label" for="heure-depart">
              Heure de d√©part habituelle *
            </label>
            <input class="fr-input" type="time" id="heure-depart" name="heure-depart" required>
          </div>

        </div>
      </fieldset>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- SECTION 4 : INFORMATIONS COMPL√âMENTAIRES                -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <fieldset class="fr-fieldset">
        <legend class="fr-fieldset__legend">
          <h2 class="fr-h5">4. Informations compl√©mentaires</h2>
        </legend>
        
        <div class="fr-fieldset__content">
          
          <!-- Handicap (checkbox bool√©enne facultative) -->
          <div class="fr-checkbox-group">
            <input type="checkbox" id="handicap" name="handicap" value="true">
            <label class="fr-label" for="handicap">
              Je suis porteur d'un handicap
              <span class="fr-hint-text">Cette information reste confidentielle et nous permet d'adapter nos propositions de mobilit√©</span>
            </label>
          </div>

          <!-- T√©l√©phone (en bas comme demand√©) -->
          <div class="fr-input-group">
            <label class="fr-label" for="telephone">
              Num√©ro de t√©l√©phone
              <span class="fr-hint-text">Si vous √™tes volontaire pour nous aider √† am√©liorer la proposition de mobilit√© alternative, indiquez votre num√©ro pour qu'on puisse √©changer 5 min avec vous</span>
            </label>
            <input class="fr-input" type="tel" id="telephone" name="telephone" placeholder="06 12 34 56 78">
          </div>

        </div>
      </fieldset>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- BOUTON SOUMISSION                                       -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="fr-mt-4w">
        <button type="submit" class="fr-btn" id="btn-submit">
          Envoyer mon diagnostic
        </button>
      </div>

    </form>
  </div>

  <!-- DSFR JS -->
  <script src="https://unpkg.com/@gouvfr/dsfr@1.11.2/dist/dsfr.module.min.js" type="module"></script>
  <script src="https://unpkg.com/@gouvfr/dsfr@1.11.2/dist/dsfr.nomodule.min.js" nomodule></script>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INITIALISATION GRIST
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    grist.ready();
    console.log('‚úÖ Grist initialis√© - Formulaire pr√™t');

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // QUESTIONS CONDITIONNELLES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const transportInputs = document.querySelectorAll('input[name="transport"]');
    const questionParking = document.getElementById('question-parking');
    const questionMentorVelo = document.getElementById('question-mentor-velo');
    
    transportInputs.forEach(input => {
      input.addEventListener('change', function() {
        const value = this.value;
        
        // Afficher question parking si voiture (sans passagers) ou covoiturage
        if (value === 'Voiture (sans passagers)' || value === 'Covoiturage') {
          questionParking.classList.add('visible');
        } else {
          questionParking.classList.remove('visible');
          document.getElementById('difficulte-parking').checked = false;
        }
        
        // Afficher question mentor v√©lo si v√©lo
        if (value === 'V√©lo musculaire' || value === 'V√©lo √©lectrique') {
          questionMentorVelo.classList.add('visible');
        } else {
          questionMentorVelo.classList.remove('visible');
          document.getElementById('mentor-velo').checked = false;
        }
      });
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AUTOCOMPL√âTION ADRESSES (API BAN)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const gpsData = {
      domicile: { lat: null, lon: null, label: '' },
      travail: { lat: null, lon: null, label: '' },
      route: {
        distVoiture: 0,
        dureeVoiture: 0,
        polylineVoiture: '',
        distVelo: 0,
        dureeVelo: 0,
        polylineVelo: ''
      }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CALCUL AUTOMATIQUE DES TRAJETS (OSRM)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function calcRoute() {
      // V√©rifier que les deux adresses sont saisies
      if (!gpsData.domicile.lat || !gpsData.travail.lat) {
        return;
      }

      const p1 = `${gpsData.domicile.lon},${gpsData.domicile.lat}`;
      const p2 = `${gpsData.travail.lon},${gpsData.travail.lat}`;

      try {
        // üöó TRAJET VOITURE
        const rCar = await fetch(`https://router.project-osrm.org/route/v1/driving/${p1};${p2}?overview=full&geometries=geojson`);
        const jCar = await rCar.json();

        if (jCar.routes?.[0]) {
          gpsData.route.distVoiture = (jCar.routes[0].distance / 1000).toFixed(2);
          gpsData.route.dureeVoiture = Math.round(jCar.routes[0].duration / 60);

          // Encoder en polyline (90% plus compact que GeoJSON)
          const coords = jCar.routes[0].geometry.coordinates.map(c => [c[1], c[0]]); // Inverser lon,lat -> lat,lon
          gpsData.route.polylineVoiture = polyline.encode(coords);

          console.log('‚úÖ Trajet voiture:', gpsData.route.distVoiture, 'km en', gpsData.route.dureeVoiture, 'min');
        }

        // üö¥ TRAJET V√âLO
        const rBike = await fetch(`https://router.project-osrm.org/route/v1/cycling/${p1};${p2}?overview=full&geometries=geojson`);
        const jBike = await rBike.json();

        if (jBike.routes?.[0]) {
          gpsData.route.distVelo = (jBike.routes[0].distance / 1000).toFixed(2);
          gpsData.route.dureeVelo = Math.round(jBike.routes[0].duration / 60);

          // Encoder en polyline
          const coords = jBike.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
          gpsData.route.polylineVelo = polyline.encode(coords);

          console.log('‚úÖ Trajet v√©lo:', gpsData.route.distVelo, 'km en', gpsData.route.dureeVelo, 'min');
        }

        console.log('‚úÖ Trajets calcul√©s et encod√©s en polyline');

      } catch (e) {
        console.error('‚ö†Ô∏è Erreur calcul trajet:', e);
      }
    }

    function setupAutocomplete(inputId, suggestionsId, type) {
      const input = document.getElementById(inputId);
      const suggestions = document.getElementById(suggestionsId);
      let debounceTimer;

      input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        
        if (query.length < 3) {
          suggestions.style.display = 'none';
          return;
        }

        debounceTimer = setTimeout(async () => {
          try {
            const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
            const data = await response.json();
            
            suggestions.innerHTML = '';
            
            if (data.features && data.features.length > 0) {
              data.features.forEach(feature => {
                const div = document.createElement('div');
                div.textContent = feature.properties.label;
                div.addEventListener('click', () => {
                  input.value = feature.properties.label;
                  gpsData[type].lat = feature.geometry.coordinates[1];
                  gpsData[type].lon = feature.geometry.coordinates[0];
                  gpsData[type].label = feature.properties.label;

                  // Mettre √† jour les champs cach√©s
                  if (type === 'domicile') {
                    document.getElementById('gps-dom-lat').value = gpsData[type].lat;
                    document.getElementById('gps-dom-lon').value = gpsData[type].lon;
                  } else {
                    document.getElementById('gps-trav-lat').value = gpsData[type].lat;
                    document.getElementById('gps-trav-lon').value = gpsData[type].lon;
                  }

                  suggestions.style.display = 'none';

                  // Calculer automatiquement les trajets en arri√®re-plan
                  calcRoute();
                });
                suggestions.appendChild(div);
              });
              suggestions.style.display = 'block';
            } else {
              suggestions.style.display = 'none';
            }
          } catch (error) {
            console.error('Erreur API BAN:', error);
          }
        }, 300);
      });

      // Cacher suggestions si clic ailleurs
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
          suggestions.style.display = 'none';
        }
      });
    }

    setupAutocomplete('adresse-domicile', 'suggestions-domicile', 'domicile');
    setupAutocomplete('adresse-travail', 'suggestions-travail', 'travail');

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SOUMISSION DU FORMULAIRE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.getElementById('diagmob-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Validation RGPD
      if (!document.getElementById('rgpd').checked) {
        alert('Veuillez accepter le traitement de vos donn√©es (RGPD).');
        return;
      }
      
      // Validation GPS
      if (!gpsData.domicile.lat || !gpsData.travail.lat) {
        alert('Veuillez s√©lectionner une adresse dans la liste de suggestions pour le domicile et le travail.');
        return;
      }

      // R√©cup√©rer les valeurs
      const email = document.getElementById('email').value;
      const service = document.getElementById('service').value;
      const telephone = document.getElementById('telephone').value || '';
      const handicap = document.getElementById('handicap').checked;
      const difficuteParking = document.getElementById('difficulte-parking').checked;
      const mentorVelo = document.getElementById('mentor-velo').checked;
      const nbJoursSemaine = document.getElementById('nb-jours-semaine').value;
      
      // Jours de pr√©sence
      const joursChecked = document.querySelectorAll('input[name="jours"]:checked');
      const jours = Array.from(joursChecked).map(cb => cb.value).join(', ');
      
      if (jours.length === 0) {
        alert('Veuillez s√©lectionner au moins un jour de pr√©sence.');
        return;
      }

      const fields = {
        Email_Pro: email,
        Service: service,
        Telephone: telephone,
        Handicap: handicap,
        Difficulte_Parking: difficuteParking,
        Mentor_Velo: mentorVelo,
        Adresse_Domicile: gpsData.domicile.label,
        GPS_Dom_Lat: gpsData.domicile.lat,
        GPS_Dom_Lon: gpsData.domicile.lon,
        Adresse_Travail: gpsData.travail.label,
        GPS_Trav_Lat: gpsData.travail.lat,
        GPS_Trav_Lon: gpsData.travail.lon,
        Mode_Transport: document.querySelector('input[name="transport"]:checked').value,
        Jours_Site_Moyenne: parseInt(nbJoursSemaine),
        Jours_Presence: jours,
        Heure_Arrivee: document.getElementById('heure-arrivee').value,
        Heure_Depart: document.getElementById('heure-depart').value,

        // üöó Donn√©es trajet voiture
        Distance_Voiture_km: parseFloat(gpsData.route.distVoiture) || 0,
        Temps_Voiture_min: gpsData.route.dureeVoiture || 0,
        Trajet_Voiture_Polyline: gpsData.route.polylineVoiture || '',

        // üö¥ Donn√©es trajet v√©lo
        Distance_Velo_km: parseFloat(gpsData.route.distVelo) || 0,
        Temps_Velo_min: gpsData.route.dureeVelo || 0,
        Trajet_Velo_Polyline: gpsData.route.polylineVelo || ''
      };
      
      try {
        // D√©sactiver le bouton
        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.textContent = 'Envoi en cours...';
        
        console.log('üì§ Envoi vers Grist...', fields);
        
        // Envoyer √† Grist
        await grist.docApi.applyUserActions([
          ['AddRecord', 'DiagmobV2', null, fields]
        ]);
        
        console.log('‚úÖ Donn√©es enregistr√©es');
        
        // Succ√®s
        document.getElementById('success-message').style.display = 'block';
        document.getElementById('diagmob-form').reset();
        
        // R√©initialiser les questions conditionnelles
        questionParking.classList.remove('visible');
        questionMentorVelo.classList.remove('visible');
        
        // R√©initialiser les donn√©es GPS
        gpsData.domicile = { lat: null, lon: null, label: '' };
        gpsData.travail = { lat: null, lon: null, label: '' };
        
        // Scroll vers le haut pour voir le message
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        setTimeout(() => {
          document.getElementById('success-message').style.display = 'none';
          btn.disabled = false;
          btn.textContent = 'Envoyer mon diagnostic';
        }, 5000);
        
      } catch (error) {
        console.error('‚ùå Erreur soumission:', error);
        alert('Erreur lors de l\'envoi. Veuillez r√©essayer.');
        
        const btn = document.getElementById('btn-submit');
        btn.disabled = false;
        btn.textContent = 'Envoyer mon diagnostic';
      }
    });
  </script>

</body>
</html>
