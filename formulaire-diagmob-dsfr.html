<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diag Mob - Diagnostic MobilitÃ©</title>
  
  <!-- DSFR CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
  <link rel="stylesheet" href="https://unpkg.com/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">
  
  <!-- Grist API -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    
    .container-formulaire {
      max-width: 700px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    
    /* Force disposition verticale pour tous les groupes */
    .fr-fieldset__content {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    /* Chaque groupe d'input sur toute la largeur */
    .fr-input-group,
    .fr-select-group,
    .fr-checkbox-group,
    .fr-radio-group {
      width: 100%;
      max-width: 100%;
    }
    
    /* Fix checkbox Lundi - forcer carrÃ© parfait */
    .fr-checkbox-group input[type="checkbox"] {
      width: 1.5rem !important;
      height: 1.5rem !important;
      min-width: 1.5rem !important;
      min-height: 1.5rem !important;
    }
    
    /* Suggestions autocomplÃ©tion */
    .autocomplete-wrapper {
      position: relative;
    }
    
    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border-default-grey);
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 0 0 4px 4px;
    }
    
    .suggestions div {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border-default-grey);
    }
    
    .suggestions div:hover {
      background-color: var(--background-alt-blue-france);
    }
    
    /* Message succÃ¨s */
    .success-message {
      display: none;
      background-color: var(--background-contrast-success);
      border-left: 4px solid var(--border-plain-success);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    
    /* Sections espacÃ©es */
    .fr-fieldset {
      margin-bottom: 2rem;
    }
    
    /* Questions conditionnelles */
    .question-conditionnelle {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background-color: var(--background-alt-blue-france);
      border-radius: 4px;
      border-left: 3px solid var(--border-action-high-blue-france);
    }
    
    .question-conditionnelle.visible {
      display: block;
    }
    
    /* Texte intro */
    .intro-text {
      background-color: var(--background-alt-blue-france);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }
    
    .intro-text ul {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }
    
    .intro-text li {
      margin-bottom: 0.5rem;
    }
    
    /* Select avec plus d'options visibles */
    .fr-select {
      max-height: none;
    }
  </style>
</head>
<body>

  <div class="container-formulaire">
    
    <!-- En-tÃªte -->
    <div class="fr-mb-2w">
      <h1 class="fr-h3">ğŸ“‹ Diag Mob - Diagnostic MobilitÃ©</h1>
      <p class="fr-text--sm fr-mb-0">
        Les champs marquÃ©s d'un astÃ©risque (*) sont obligatoires.
      </p>
    </div>

    <!-- Texte introductif -->
    <div class="intro-text">
      <p><strong>Bonjour,</strong></p>
      <p>Et si vos trajets domicile-travail devenaient plus Ã©conomiques, conviviaux et Ã©cologiques ?</p>
      <p>Nous lanÃ§ons un service numÃ©rique sur le potentiel de mobilitÃ© alternatives entre agents publics, portÃ©e par le ministÃ¨re des Transports et la Fabrique NumÃ©rique.</p>
      <p>ğŸ‘‰ <strong>Exemple concret :</strong> un agent qui habite Ã  30 km de son lieu de travail et covoiture en alternance avec un collÃ¨gue Ã©conomise prÃ¨s de <strong>2 000 â‚¬ par an</strong>.</p>
      <p>En rÃ©pondant Ã  ce questionnaire, vous pourrez :</p>
      <ul>
        <li>RÃ©duire vos frais de dÃ©placement,</li>
        <li>ÃŠtre mis en relation avec des collÃ¨gues proches de chez vous pour expÃ©rimenter le covoiturage ou le vÃ©lotaf,</li>
        <li>BÃ©nÃ©ficier du Forfait MobilitÃ©s Durables (100 Ã  300 â‚¬ par an),</li>
        <li>Contribuer Ã  la transition Ã©cologique.</li>
      </ul>
    </div>

    <!-- Message succÃ¨s -->
    <div class="success-message fr-alert fr-alert--success" id="success-message">
      <p class="fr-alert__title">Merci !</p>
      <p>Votre diagnostic mobilitÃ© a bien Ã©tÃ© enregistrÃ©.</p>
    </div>

    <form id="diagmob-form">
      
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- SECTION 1 : INFORMATIONS PERSONNELLES                   -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <fieldset class="fr-fieldset">
        <legend class="fr-fieldset__legend">
          <h2 class="fr-h5">1. Vos informations</h2>
        </legend>
        
        <div class="fr-fieldset__content">
          
          <!-- RGPD avec texte complet -->
          <div class="fr-checkbox-group">
            <input type="checkbox" id="rgpd" name="rgpd" value="Oui" required>
            <label class="fr-label" for="rgpd">
              J'accepte le traitement de mes donnÃ©es (RGPD) *
              <span class="fr-hint-text">J'accepte que mes donnÃ©es personnelles (ville de domicile, adresse de travail et adresse e-mail) soient utilisÃ©es uniquement dans le cadre de cette dÃ©marche de cartographie des trajets et de changement d'habitude de mobilitÃ©s par l'Ã©quipe Diag'Mob et les rÃ©fÃ©rents mobilitÃ©s de mon service, pendant une durÃ©e maximale de 12 mois, conformÃ©ment aux informations fournies sur notre page RGPD.</span>
            </label>
          </div>

          <!-- Email -->
          <div class="fr-input-group">
            <label class="fr-label" for="email">
              Adresse mail professionnelle *
              <span class="fr-hint-text">ou personnelle si vous n'en possÃ©dez pas</span>
            </label>
            <input class="fr-input" type="email" id="email" name="email" placeholder="prenom.nom@ministere.gouv.fr" required>
          </div>

          <!-- Service / MinistÃ¨re -->
          <div class="fr-select-group">
            <label class="fr-label" for="service">
              Service / MinistÃ¨re de rattachement *
            </label>
            <select class="fr-select" id="service" name="service" required>
              <option value="">â€” SÃ©lectionnez votre service â€”</option>
            </select>
          </div>

        </div>
      </fieldset>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- SECTION 2 : VOS TRAJETS                                 -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <fieldset class="fr-fieldset">
        <legend class="fr-fieldset__legend">
          <h2 class="fr-h5">2. Vos trajets</h2>
        </legend>
        
        <div class="fr-fieldset__content">
          
          <!-- Adresse domicile -->
          <div class="fr-input-group">
            <label class="fr-label" for="adresse-domicile">
              Adresse de domicile *
            </label>
            <div class="autocomplete-wrapper">
              <input class="fr-input" type="text" id="adresse-domicile" name="adresse-domicile" placeholder="Commencez Ã  saisir votre adresse..." required autocomplete="off">
              <div class="suggestions" id="suggestions-domicile"></div>
            </div>
            <input type="hidden" id="gps-dom-lat" name="gps-dom-lat">
            <input type="hidden" id="gps-dom-lon" name="gps-dom-lon">
          </div>

          <!-- Adresse travail -->
          <div class="fr-input-group">
            <label class="fr-label" for="adresse-travail">
              Adresse de travail *
            </label>
            <div class="autocomplete-wrapper">
              <input class="fr-input" type="text" id="adresse-travail" name="adresse-travail" placeholder="Commencez Ã  saisir votre adresse..." required autocomplete="off">
              <div class="suggestions" id="suggestions-travail"></div>
            </div>
            <input type="hidden" id="gps-trav-lat" name="gps-trav-lat">
            <input type="hidden" id="gps-trav-lon" name="gps-trav-lon">
          </div>

        </div>
      </fieldset>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- SECTION 3 : HABITUDES DE MOBILITÃ‰                       -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <fieldset class="fr-fieldset">
        <legend class="fr-fieldset__legend">
          <h2 class="fr-h5">3. Habitudes de mobilitÃ©</h2>
        </legend>
        
        <div class="fr-fieldset__content">
          
          <!-- Mode de transport principal -->
          <div class="fr-form-group">
            <fieldset class="fr-fieldset">
              <legend class="fr-fieldset__legend fr-text--regular">
                Mode de transport principal *
              </legend>
              <div class="fr-fieldset__content">
                <div class="fr-radio-group">
                  <input type="radio" id="transport-voiture" name="transport" value="Voiture (sans passagers)" required>
                  <label class="fr-label" for="transport-voiture">ğŸš— Voiture (sans passagers)</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-covoit" name="transport" value="Covoiturage">
                  <label class="fr-label" for="transport-covoit">ğŸš—ğŸ‘¥ Covoiturage</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-tc" name="transport" value="Transports en commun">
                  <label class="fr-label" for="transport-tc">ğŸšŒ Transports en commun</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-velo" name="transport" value="VÃ©lo musculaire">
                  <label class="fr-label" for="transport-velo">ğŸš´ VÃ©lo musculaire</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-vae" name="transport" value="VÃ©lo Ã©lectrique">
                  <label class="fr-label" for="transport-vae">ğŸš´âš¡ VÃ©lo Ã©lectrique</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-marche" name="transport" value="Marche Ã  pied">
                  <label class="fr-label" for="transport-marche">ğŸš¶ Marche Ã  pied</label>
                </div>
                <div class="fr-radio-group">
                  <input type="radio" id="transport-inter" name="transport" value="IntermodalitÃ©">
                  <label class="fr-label" for="transport-inter">ğŸš—ğŸšŒ IntermodalitÃ©</label>
                </div>
              </div>
            </fieldset>
            
            <!-- Question conditionnelle : DifficultÃ© parking (si voiture) -->
            <div class="question-conditionnelle" id="question-parking">
              <div class="fr-checkbox-group">
                <input type="checkbox" id="difficulte-parking" name="difficulte-parking" value="true">
                <label class="fr-label" for="difficulte-parking">
                  J'ai des difficultÃ©s Ã  me garer sur mon lieu de travail
                </label>
              </div>
            </div>
            
            <!-- Question conditionnelle : Mentor vÃ©lo (si vÃ©lo) -->
            <div class="question-conditionnelle" id="question-mentor-velo">
              <div class="fr-checkbox-group">
                <input type="checkbox" id="mentor-velo" name="mentor-velo" value="true">
                <label class="fr-label" for="mentor-velo">
                  Je suis prÃªt(e) Ã  Ãªtre mentor vÃ©lo pour accompagner un collÃ¨gue dans ses premiers trajets
                  <span class="fr-hint-text">Vous pourrez Ãªtre mis en relation avec des collÃ¨gues souhaitant dÃ©buter le vÃ©lotaf</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Nombre de jours prÃ©sent sur site par semaine -->
          <div class="fr-select-group">
            <label class="fr-label" for="nb-jours-semaine">
              Nombre de jours prÃ©sent sur site par semaine *
            </label>
            <select class="fr-select" id="nb-jours-semaine" name="nb-jours-semaine" required>
              <option value="">-- SÃ©lectionnez --</option>
              <option value="1">1 jour</option>
              <option value="2">2 jours</option>
              <option value="3">3 jours</option>
              <option value="4">4 jours</option>
              <option value="5">5 jours</option>
            </select>
          </div>

          <!-- Jours de prÃ©sence -->
          <div class="fr-form-group">
            <fieldset class="fr-fieldset">
              <legend class="fr-fieldset__legend fr-text--regular">
                Jours de prÃ©sence sur site *
              </legend>
              <div class="fr-fieldset__content">
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-lundi" name="jours" value="Lundi">
                  <label class="fr-label" for="jour-lundi">Lundi</label>
                </div>
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-mardi" name="jours" value="Mardi">
                  <label class="fr-label" for="jour-mardi">Mardi</label>
                </div>
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-mercredi" name="jours" value="Mercredi">
                  <label class="fr-label" for="jour-mercredi">Mercredi</label>
                </div>
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-jeudi" name="jours" value="Jeudi">
                  <label class="fr-label" for="jour-jeudi">Jeudi</label>
                </div>
                <div class="fr-checkbox-group">
                  <input type="checkbox" id="jour-vendredi" name="jours" value="Vendredi">
                  <label class="fr-label" for="jour-vendredi">Vendredi</label>
                </div>
              </div>
            </fieldset>
          </div>

          <!-- Heure d'arrivÃ©e -->
          <div class="fr-input-group">
            <label class="fr-label" for="heure-arrivee">
              Heure d'arrivÃ©e habituelle *
            </label>
            <input class="fr-input" type="time" id="heure-arrivee" name="heure-arrivee" required>
          </div>

          <!-- Heure de dÃ©part -->
          <div class="fr-input-group">
            <label class="fr-label" for="heure-depart">
              Heure de dÃ©part habituelle *
            </label>
            <input class="fr-input" type="time" id="heure-depart" name="heure-depart" required>
          </div>

        </div>
      </fieldset>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- SECTION 4 : INFORMATIONS COMPLÃ‰MENTAIRES                -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <fieldset class="fr-fieldset">
        <legend class="fr-fieldset__legend">
          <h2 class="fr-h5">4. Informations complÃ©mentaires</h2>
        </legend>
        
        <div class="fr-fieldset__content">
          
          <!-- Handicap (checkbox boolÃ©enne facultative) -->
          <div class="fr-checkbox-group">
            <input type="checkbox" id="handicap" name="handicap" value="true">
            <label class="fr-label" for="handicap">
              Je suis porteur d'un handicap
              <span class="fr-hint-text">Cette information reste confidentielle et nous permet d'adapter nos propositions de mobilitÃ©</span>
            </label>
          </div>

          <!-- TÃ©lÃ©phone (en bas comme demandÃ©) -->
          <div class="fr-input-group">
            <label class="fr-label" for="telephone">
              NumÃ©ro de tÃ©lÃ©phone
              <span class="fr-hint-text">Si vous Ãªtes volontaire pour nous aider Ã  amÃ©liorer la proposition de mobilitÃ© alternative, indiquez votre numÃ©ro pour qu'on puisse Ã©changer 5 min avec vous</span>
            </label>
            <input class="fr-input" type="tel" id="telephone" name="telephone" placeholder="06 12 34 56 78">
          </div>

        </div>
      </fieldset>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- BOUTON SOUMISSION                                       -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="fr-mt-4w">
        <button type="submit" class="fr-btn" id="btn-submit">
          Envoyer mon diagnostic
        </button>
      </div>

    </form>
  </div>

  <!-- DSFR JS -->
  <script src="https://unpkg.com/@gouvfr/dsfr@1.11.2/dist/dsfr.module.min.js" type="module"></script>
  <script src="https://unpkg.com/@gouvfr/dsfr@1.11.2/dist/dsfr.nomodule.min.js" nomodule></script>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALISATION GRIST
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    grist.ready();
    
    // Configuration Grist (Ã  adapter selon ton document)
    const GRIST_CONFIG = {
      docId: 'votre_doc_id',  // ID de ton document Grist
      tableServices: 'liste_services',  // Table contenant les services
      colonneListe: 'LibellÃ©'  // Colonne Ã  afficher
    };
    
    // Charger la liste des services depuis Grist
    async function chargerServices() {
      try {
        // Attendre que Grist soit prÃªt
        await grist.ready();
        
        // RÃ©cupÃ©rer la table des services
        const tableAccess = await grist.selectedTable.create('liste_services');
        const records = await tableAccess.fetchSelectedTable();
        
        const select = document.getElementById('service');
        select.innerHTML = '<option value="">â€” SÃ©lectionnez votre service â€”</option>';
        
        if (records && records.length > 0) {
          // Extraire la colonne LibellÃ© et trier
          const services = records
            .map(r => r.LibellÃ© || r.Libelle)
            .filter(s => s && s.trim())
            .sort();
          
          // Ã‰liminer les doublons
          const uniqueServices = [...new Set(services)];
          
          uniqueServices.forEach((service) => {
            const option = document.createElement('option');
            option.value = service;
            option.textContent = service;
            select.appendChild(option);
          });
          
          console.log(`âœ… ${uniqueServices.length} services chargÃ©s depuis Grist`);
        } else {
          console.log('âš ï¸ Aucun service trouvÃ©, chargement de la liste statique');
          chargerServicesStatiques();
        }
        
      } catch (error) {
        console.error('Erreur chargement services:', error);
        console.log('ğŸ”„ Fallback: chargement de la liste statique');
        chargerServicesStatiques();
      }
    }
    
    function chargerServicesStatiques() {
      const select = document.getElementById('service');
      const servicesStatiques = [
        "Services du Premier ministre",
        "MinistÃ¨re de l'IntÃ©rieur et des Outre-mer",
        "MinistÃ¨re de la Justice",
        "MinistÃ¨re des ArmÃ©es",
        "MinistÃ¨re de l'Ã‰conomie et des Finances",
        "MinistÃ¨re de l'Ã‰ducation nationale et de la Jeunesse",
        "MinistÃ¨re de l'Enseignement supÃ©rieur et de la Recherche",
        "MinistÃ¨re de l'Agriculture et de la SouverainetÃ© alimentaire",
        "MinistÃ¨re de la Transition Ã©cologique",
        "MinistÃ¨re de la SantÃ© et des SolidaritÃ©s",
        "MinistÃ¨re de la Culture du travail et des solidaritÃ©s",
        "Direction rÃ©gionale de l'Ã©conomie de l'emploi, du travail et des solidaritÃ©s",
        "Direction rÃ©gionale de l'environnement  de l'amÃ©nagement et du logement",
        "Direction rÃ©gionale de l'alimentation  de l'agriculture et de la forÃªt",
        "Direction rÃ©gionale des affaires culturelles",
        "Rectorat d'acadÃ©mie",
        "Agence rÃ©gionale de santÃ©",
        "Direction dÃ©partementale des territoires",
        "Direction dÃ©partementale des territoires et de la mer",
        "Direction dÃ©partementale de l'emploi  du travail et des solidaritÃ©s",
        "Direction dÃ©partementale de la protection des populations",
        "Direction dÃ©p. de l'emploi  du travail  des solidaritÃ©s et de la protection des populations",
        "Direction des services dÃ©partementaux de l'Ã©ducation nationale",
        "Direction dÃ©partementale des finances publiques",
        "PrÃ©fecture de dÃ©partement",
        "Sous-prÃ©fecture",
        "France Travail",
        "Caisse d'Allocations Familiales",
        "Caisse Primaire d'Assurance Maladie",
        "Agence de l'environnement et de la maÃ®trise de l'Ã©nergie",
        "Centre national de la recherche scientifique"
      ];
      
      select.innerHTML = '<option value="">â€” SÃ©lectionnez votre service â€”</option>';
      servicesStatiques.forEach((service) => {
        const option = document.createElement('option');
        option.value = service;
        option.textContent = service;
        select.appendChild(option);
      });
      
      console.log(`âœ… ${servicesStatiques.length} services statiques chargÃ©s`);
    }
    
    // Charger les services au dÃ©marrage
    chargerServices();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // QUESTIONS CONDITIONNELLES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const transportInputs = document.querySelectorAll('input[name="transport"]');
    const questionParking = document.getElementById('question-parking');
    const questionMentorVelo = document.getElementById('question-mentor-velo');
    
    transportInputs.forEach(input => {
      input.addEventListener('change', function() {
        const value = this.value;
        
        // Afficher question parking si voiture (sans passagers) ou covoiturage
        if (value === 'Voiture (sans passagers)' || value === 'Covoiturage') {
          questionParking.classList.add('visible');
        } else {
          questionParking.classList.remove('visible');
          document.getElementById('difficulte-parking').checked = false;
        }
        
        // Afficher question mentor vÃ©lo si vÃ©lo
        if (value === 'VÃ©lo musculaire' || value === 'VÃ©lo Ã©lectrique') {
          questionMentorVelo.classList.add('visible');
        } else {
          questionMentorVelo.classList.remove('visible');
          document.getElementById('mentor-velo').checked = false;
        }
      });
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTOCOMPLÃ‰TION ADRESSES (API BAN)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const gpsData = {
      domicile: { lat: null, lon: null, label: '' },
      travail: { lat: null, lon: null, label: '' }
    };

    function setupAutocomplete(inputId, suggestionsId, type) {
      const input = document.getElementById(inputId);
      const suggestions = document.getElementById(suggestionsId);
      let debounceTimer;

      input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        
        if (query.length < 3) {
          suggestions.style.display = 'none';
          return;
        }

        debounceTimer = setTimeout(async () => {
          try {
            const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
            const data = await response.json();
            
            suggestions.innerHTML = '';
            
            if (data.features && data.features.length > 0) {
              data.features.forEach(feature => {
                const div = document.createElement('div');
                div.textContent = feature.properties.label;
                div.addEventListener('click', () => {
                  input.value = feature.properties.label;
                  gpsData[type].lat = feature.geometry.coordinates[1];
                  gpsData[type].lon = feature.geometry.coordinates[0];
                  gpsData[type].label = feature.properties.label;
                  
                  // Mettre Ã  jour les champs cachÃ©s
                  if (type === 'domicile') {
                    document.getElementById('gps-dom-lat').value = gpsData[type].lat;
                    document.getElementById('gps-dom-lon').value = gpsData[type].lon;
                  } else {
                    document.getElementById('gps-trav-lat').value = gpsData[type].lat;
                    document.getElementById('gps-trav-lon').value = gpsData[type].lon;
                  }
                  
                  suggestions.style.display = 'none';
                });
                suggestions.appendChild(div);
              });
              suggestions.style.display = 'block';
            } else {
              suggestions.style.display = 'none';
            }
          } catch (error) {
            console.error('Erreur API BAN:', error);
          }
        }, 300);
      });

      // Cacher suggestions si clic ailleurs
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
          suggestions.style.display = 'none';
        }
      });
    }

    setupAutocomplete('adresse-domicile', 'suggestions-domicile', 'domicile');
    setupAutocomplete('adresse-travail', 'suggestions-travail', 'travail');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SOUMISSION DU FORMULAIRE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('diagmob-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Validation RGPD
      if (!document.getElementById('rgpd').checked) {
        alert('Veuillez accepter le traitement de vos donnÃ©es (RGPD).');
        return;
      }
      
      // Validation GPS
      if (!gpsData.domicile.lat || !gpsData.travail.lat) {
        alert('Veuillez sÃ©lectionner une adresse dans la liste de suggestions pour le domicile et le travail.');
        return;
      }

      // RÃ©cupÃ©rer les valeurs
      const email = document.getElementById('email').value;
      const service = document.getElementById('service').value;
      const telephone = document.getElementById('telephone').value || '';
      const handicap = document.getElementById('handicap').checked;
      const difficuteParking = document.getElementById('difficulte-parking').checked;
      const mentorVelo = document.getElementById('mentor-velo').checked;
      const nbJoursSemaine = document.getElementById('nb-jours-semaine').value;
      
      // Jours de prÃ©sence
      const joursChecked = document.querySelectorAll('input[name="jours"]:checked');
      const jours = Array.from(joursChecked).map(cb => cb.value).join(', ');
      
      if (jours.length === 0) {
        alert('Veuillez sÃ©lectionner au moins un jour de prÃ©sence.');
        return;
      }

      const fields = {
        Email_Pro: email,
        Service: service,
        Telephone: telephone,
        Handicap: handicap,
        Difficulte_Parking: difficuteParking,
        Mentor_Velo: mentorVelo,
        Adresse_Domicile: gpsData.domicile.label,
        GPS_Dom_Lat: gpsData.domicile.lat,
        GPS_Dom_Lon: gpsData.domicile.lon,
        Adresse_Travail: gpsData.travail.label,
        GPS_Trav_Lat: gpsData.travail.lat,
        GPS_Trav_Lon: gpsData.travail.lon,
        Mode_Transport: document.querySelector('input[name="transport"]:checked').value,
        Jours_Site_Moyenne: parseInt(nbJoursSemaine),
        Jours_Presence: jours,
        Heure_Arrivee: document.getElementById('heure-arrivee').value,
        Heure_Depart: document.getElementById('heure-depart').value
      };
      
      try {
        // DÃ©sactiver le bouton
        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.textContent = 'Envoi en cours...';
        
        // Envoyer Ã  Grist
        await grist.docApi.applyUserActions([
          ['AddRecord', 'DiagmobV2', null, fields]
        ]);
        
        // SuccÃ¨s
        document.getElementById('success-message').style.display = 'block';
        document.getElementById('diagmob-form').reset();
        
        // RÃ©initialiser les questions conditionnelles
        questionParking.classList.remove('visible');
        questionMentorVelo.classList.remove('visible');
        
        // RÃ©initialiser les donnÃ©es GPS
        gpsData.domicile = { lat: null, lon: null, label: '' };
        gpsData.travail = { lat: null, lon: null, label: '' };
        
        // Scroll vers le haut pour voir le message
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        setTimeout(() => {
          document.getElementById('success-message').style.display = 'none';
          btn.disabled = false;
          btn.textContent = 'Envoyer mon diagnostic';
        }, 5000);
        
      } catch (error) {
        console.error('Erreur soumission:', error);
        alert('Erreur lors de l\'envoi. Veuillez rÃ©essayer.');
        
        const btn = document.getElementById('btn-submit');
        btn.disabled = false;
        btn.textContent = 'Envoyer mon diagnostic';
      }
    });
  </script>

</body>
</html>
