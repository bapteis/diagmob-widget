<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Saisie Adresse BAN</title>
  <style>
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f8f9fa;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    h2 {
      margin: 0 0 20px 0;
      color: #2d3748;
      font-size: 24px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #4a5568;
      font-size: 14px;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .autocomplete {
      position: relative;
    }
    
    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #e2e8f0;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
    }
    
    .suggestions.show {
      display: block;
    }
    
    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f7fafc;
      transition: background 0.2s;
    }
    
    .suggestion-item:hover {
      background: #edf2f7;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-label {
      font-weight: 500;
      color: #2d3748;
      margin-bottom: 4px;
    }
    
    .suggestion-context {
      font-size: 12px;
      color: #718096;
    }
    
    .score-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }
    
    .score-excellent {
      background: #d4edda;
      color: #155724;
    }
    
    .score-good {
      background: #fff3cd;
      color: #856404;
    }
    
    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
      margin-top: 10px;
    }
    
    .btn:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
    }
    
    .info {
      background: #ebf8ff;
      border-left: 4px solid #3182ce;
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #2c5282;
    }
    
    .selected-address {
      background: #f0fff4;
      border: 2px solid #48bb78;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .selected-address h4 {
      margin: 0 0 10px 0;
      color: #22543d;
      font-size: 14px;
    }
    
    .selected-address p {
      margin: 5px 0;
      font-size: 14px;
      color: #2f855a;
    }
    
    .loading {
      text-align: center;
      padding: 12px;
      color: #718096;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üè† Saisie de l'adresse</h2>
    
    <div class="info">
      üí° <strong>Astuce :</strong> Commencez √† taper votre adresse, les suggestions appara√Ætront automatiquement.
    </div>
    
    <!-- DOMICILE -->
    <div class="form-group">
      <label for="adresse-dom">üìç Adresse du domicile</label>
      <div class="autocomplete">
        <input 
          type="text" 
          id="adresse-dom" 
          placeholder="Ex: 20 avenue de S√©gur, 75007 Paris"
          autocomplete="off"
        >
        <div class="suggestions" id="suggestions-dom"></div>
      </div>
    </div>
    
    <div id="selected-dom"></div>
    
    <!-- TRAVAIL -->
    <div class="form-group" style="margin-top: 30px;">
      <label for="adresse-trav">üíº Adresse du travail</label>
      <div class="autocomplete">
        <input 
          type="text" 
          id="adresse-trav" 
          placeholder="Ex: 1 rue de la Paix, 44000 Nantes"
          autocomplete="off"
        >
        <div class="suggestions" id="suggestions-trav"></div>
      </div>
    </div>
    
    <div id="selected-trav"></div>
    
    <button class="btn" id="save-btn" disabled>
      üíæ Enregistrer dans Grist
    </button>
  </div>

  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  
  <script>
    let selectedTable;
    let currentRecord;
    let selectedDomicile = null;
    let selectedTravail = null;
    
    // Initialisation Grist
    grist.ready({
      requiredAccess: 'full',
      columns: [
        { name: 'Adresse_complete_domicile', type: 'Text', optional: true },
        { name: 'rue_domicile', type: 'Text', optional: true },
        { name: 'Code_postal__et_commune_domicile', type: 'Text', optional: true },
        { name: 'Domicile_X_longitude_GPS2', type: 'Numeric', optional: true },
        { name: 'Domicile_Y_latitude_GPS2', type: 'Numeric', optional: true },
        { name: 'Adresse_complete_travail', type: 'Text', optional: true },
        { name: 'rue_travail', type: 'Text', optional: true },
        { name: 'Code_postal___commune_de_travail', type: 'Text', optional: true },
        { name: 'Travail_X_longitude_GPS', type: 'Numeric', optional: true },
        { name: 'Travail_Y_latitude_GPS', type: 'Numeric', optional: true }
      ]
    });
    
    grist.onRecords(async function(records, mappings) {
      selectedTable = await grist.getTable();
    });
    
    grist.onRecord(function(record) {
      currentRecord = record;
      
      // Pr√©-remplit si donn√©es existantes
      if (record.Adresse_complete_domicile) {
        document.getElementById('adresse-dom').value = record.Adresse_complete_domicile;
      }
      if (record.Adresse_complete_travail) {
        document.getElementById('adresse-trav').value = record.Adresse_complete_travail;
      }
    });
    
    // Debounce pour √©viter trop de requ√™tes
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Recherche adresses via API BAN
    async function searchAddress(query, suggestionsDiv) {
      if (query.length < 3) {
        suggestionsDiv.classList.remove('show');
        return;
      }
      
      try {
        const response = await fetch(
          `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`
        );
        const data = await response.json();
        
        displaySuggestions(data.features, suggestionsDiv);
      } catch (error) {
        console.error('Erreur API BAN:', error);
      }
    }
    
    // Affiche les suggestions
    function displaySuggestions(features, suggestionsDiv) {
      if (features.length === 0) {
        suggestionsDiv.innerHTML = '<div class="loading">Aucune adresse trouv√©e</div>';
        suggestionsDiv.classList.add('show');
        return;
      }
      
      let html = '';
      features.forEach((feature, index) => {
        const props = feature.properties;
        const score = props.score;
        const scoreClass = score >= 0.8 ? 'score-excellent' : 'score-good';
        const scoreLabel = score >= 0.8 ? 'Excellente' : 'Bonne';
        
        html += `
          <div class="suggestion-item" data-index="${index}">
            <div class="suggestion-label">
              ${props.label}
              <span class="score-badge ${scoreClass}">${scoreLabel}</span>
            </div>
            <div class="suggestion-context">
              ${props.context || ''}
            </div>
          </div>
        `;
      });
      
      suggestionsDiv.innerHTML = html;
      suggestionsDiv.classList.add('show');
      
      // G√©rer les clics sur suggestions
      suggestionsDiv.querySelectorAll('.suggestion-item').forEach((item, index) => {
        item.addEventListener('click', () => {
          selectAddress(features[index], suggestionsDiv);
        });
      });
    }
    
    // S√©lectionne une adresse
    function selectAddress(feature, suggestionsDiv) {
      const props = feature.properties;
      const coords = feature.geometry.coordinates;
      
      const addressData = {
        label: props.label,
        name: props.name || '',
        housenumber: props.housenumber || '',
        street: props.street || '',
        postcode: props.postcode || '',
        city: props.city || '',
        context: props.context || '',
        score: props.score,
        lon: coords[0],
        lat: coords[1]
      };
      
      // D√©termine si domicile ou travail
      const isDomicile = suggestionsDiv.id === 'suggestions-dom';
      
      if (isDomicile) {
        selectedDomicile = addressData;
        document.getElementById('adresse-dom').value = props.label;
        displaySelectedAddress(addressData, 'selected-dom');
      } else {
        selectedTravail = addressData;
        document.getElementById('adresse-trav').value = props.label;
        displaySelectedAddress(addressData, 'selected-trav');
      }
      
      suggestionsDiv.classList.remove('show');
      
      // Active le bouton si les deux adresses sont s√©lectionn√©es
      if (selectedDomicile && selectedTravail) {
        document.getElementById('save-btn').disabled = false;
      }
    }
    
    // Affiche l'adresse s√©lectionn√©e
    function displaySelectedAddress(address, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = `
        <div class="selected-address">
          <h4>‚úÖ Adresse valid√©e</h4>
          <p><strong>${address.label}</strong></p>
          <p style="font-size: 12px; color: #718096;">
            Score de confiance: ${(address.score * 100).toFixed(0)}% | 
            Coordonn√©es: ${address.lat.toFixed(6)}, ${address.lon.toFixed(6)}
          </p>
        </div>
      `;
    }
    
    // Sauvegarde dans Grist
    document.getElementById('save-btn').addEventListener('click', async function() {
      if (!selectedDomicile || !selectedTravail || !selectedTable) {
        return;
      }
      
      this.disabled = true;
      this.textContent = 'üíæ Enregistrement...';
      
      try {
        const updates = {
          // Domicile
          'Adresse_complete_domicile': selectedDomicile.label,
          'rue_domicile': selectedDomicile.street || selectedDomicile.name,
          'Code_postal__et_commune_domicile': `${selectedDomicile.postcode} - ${selectedDomicile.city}`,
          'Domicile_X_longitude_GPS2': selectedDomicile.lon,
          'Domicile_Y_latitude_GPS2': selectedDomicile.lat,
          
          // Travail
          'Adresse_complete_travail': selectedTravail.label,
          'rue_travail': selectedTravail.street || selectedTravail.name,
          'Code_postal___commune_de_travail': `${selectedTravail.postcode} - ${selectedTravail.city}`,
          'Travail_X_longitude_GPS': selectedTravail.lon,
          'Travail_Y_latitude_GPS': selectedTravail.lat
        };
        
        await selectedTable.update({
          id: currentRecord.id,
          fields: updates
        });
        
        this.textContent = '‚úÖ Enregistr√© !';
        setTimeout(() => {
          this.textContent = 'üíæ Enregistrer dans Grist';
          this.disabled = false;
        }, 2000);
        
      } catch (error) {
        console.error('Erreur sauvegarde:', error);
        this.textContent = '‚ùå Erreur';
        setTimeout(() => {
          this.textContent = 'üíæ Enregistrer dans Grist';
          this.disabled = false;
        }, 2000);
      }
    });
    
    // Event listeners pour l'autocompl√©tion
    const inputDom = document.getElementById('adresse-dom');
    const suggestionsDom = document.getElementById('suggestions-dom');
    
    inputDom.addEventListener('input', debounce(function(e) {
      searchAddress(e.target.value, suggestionsDom);
    }, 300));
    
    const inputTrav = document.getElementById('adresse-trav');
    const suggestionsTrav = document.getElementById('suggestions-trav');
    
    inputTrav.addEventListener('input', debounce(function(e) {
      searchAddress(e.target.value, suggestionsTrav);
    }, 300));
    
    // Ferme les suggestions si clic ailleurs
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.autocomplete')) {
        suggestionsDom.classList.remove('show');
        suggestionsTrav.classList.remove('show');
      }
    });
  </script>
</body>
</html>
